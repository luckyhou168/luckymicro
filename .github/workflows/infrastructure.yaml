name: Deploy infrastructure

on:
  workflow_dispatch: 

jobs:

  deploy:
    runs-on: ubuntu-latest
    
    steps:
      
      - uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4  
        with: 
         version: ${{ secrets.KUBECTL_VERSION }}   
      
      - name: Configure kubeconfig
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.kube
          printf '%s' "${{ secrets.KUBE_CONFIG }}" | base64 --decode > ~/.kube/config     
          chmod 600 ~/.kube/config

      - name: Deploy MongoDB
        run: kubectl apply -f ./scripts/cd/mongodb.yaml

      - name: Deploy Rabbit
        run: kubectl apply -f ./scripts/cd/rabbit.yaml
